<script>
    const MATCH_ID = {{ match.id }};
    const USER_ID = {{ current_user.id | tojson }};

    let state = null;
    let pollTimer = null;

    function el(id) { return document.getElementById(id); }

    function log(msg) {
        const box = el('logBox');
        const line = document.createElement('div');
        line.textContent = msg;
        box.appendChild(line);
        box.scrollTop = box.scrollHeight;
    }

    function renderCards(container, cards) {
        container.innerHTML = '';
        if (!cards) return;

        for (const c of cards) {
            const div = document.createElement('div');
            div.className = 'card' + (c.hidden ? ' back' : '');
            div.textContent = c.hidden ? 'ðŸ‚ ' : (c.rank + c.suit);
            container.appendChild(div);
        }
    }

    function setStatus(elem, txt) {
        elem.textContent = txt || '';
    }

    function clearActions() {
        el('actionButtons').innerHTML = '';
    }

    function addBtn(label, endpoint, payload=null, cls='btn') {
        const b = document.createElement('button');
        b.className = cls;
        b.textContent = label;
        b.onclick = async () => {
            try {
                await callAction(endpoint, payload);
            } catch (e) {
                console.error(e);
                log("ERROR: " + e.message);
            }
        };
        el('actionButtons').appendChild(b);
    }

    async function callAction(endpoint, payload=null) {
        const opts = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: payload ? JSON.stringify(payload) : null
        };

        const r = await fetch(`/game/${MATCH_ID}/${endpoint}`, opts);

        if (!r.ok) {
            const t = await r.text();
            throw new Error(t || r.status);
        }

        const j = await r.json();
        state = j;
        renderState();
    }

    function renderState() {
        if (!state) return;

        renderCards(el('dealerCards'), state.dealer_cards);
        renderCards(el('playerCards'), state.player_cards);

        setStatus(el('dealerStatus'), state.dealer_status_text);
        setStatus(el('playerStatus'), state.player_status_text);

        clearActions();

        // -----------------------------
        // FLOW ACTIONS
        // -----------------------------

        if (state.can_start) {
            addBtn('Start', 'start', null, 'btn primary');
        }

        if (state.can_draw) {
            addBtn('Hit', 'action', { action: 'hit' });
        }

        if (state.can_stand) {
            addBtn('Stand', 'action', { action: 'stand' });
        }

        // -----------------------------
        // CHOICE
        // -----------------------------

        if (state.can_choice && state.choice_options) {
            for (const opt of state.choice_options) {
                addBtn(opt.label, 'choice', { goes_first: opt.value });
            }
        }

        // -----------------------------
        // BETTING
        // -----------------------------

        if (state.can_bet && state.bet_options) {
            for (const b of state.bet_options) {
                addBtn('Bet ' + b, 'bet', { bets: [b] });
            }
        }

        // -----------------------------
        // INSURANCE
        // -----------------------------

        if (state.can_insurance && state.insurance_options) {
            for (const opt of state.insurance_options) {
                addBtn(opt.label, 'insurance', { decisions: [opt.value] });
            }
        }

        // -----------------------------
        // DEALER ACTION
        // -----------------------------

        if (state.can_dealer_action) {
            addBtn('Dealer Action', 'dealer_action');
        }

        // -----------------------------
        // JOKER
        // -----------------------------

        if (state.can_joker) {
            addBtn('Assign Joker', 'joker', { values: [] });
        }

        if (state.can_dealer_joker) {
            addBtn('Dealer Joker', 'dealer_joker', { values: [] });
        }

        // -----------------------------
        // NEXT ROUND
        // -----------------------------

        if (state.can_next) {
            addBtn('Next', 'next', null, 'btn primary');
        }

        if (state.can_timeout) {
            addBtn('Timeout', 'timeout', null, 'btn danger');
        }

        if (state.message) {
            log(state.message);
        }

        if (state.error) {
            log("ERROR: " + state.error);
        }
    }

    async function fetchState() {
        try {
            const r = await fetch(`/game/${MATCH_ID}/state`);
            if (!r.ok) return;
            const j = await r.json();
            state = j;
            renderState();
        } catch (e) {
            console.error(e);
        }
    }

    function startPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(fetchState, 1200);
        fetchState();
    }

    startPolling();
</script>
