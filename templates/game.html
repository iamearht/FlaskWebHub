{% extends "base.html" %}
{% block title %}Match #{{ match.id }} - Blackjack 1v1{% endblock %}
{% block content %}
<div class="game-container" id="game"
     data-match-id="{{ match.id }}"
     data-player-num="{{ player_num }}"
     data-game-mode="{{ match.game_mode }}">

    <div class="game-header">
        <div class="player-info p1 {% if player_num == 1 %}you{% endif %}">
            <span>{{ p1.username }}{% if player_num == 1 %} (You){% endif %}</span>
            <span id="p1-score"></span>
        </div>

        <div class="game-meta">
            <span>Stake: {{ match.stake }} coins</span>
            <span id="turn-info"></span>
        </div>

        <div class="player-info p2 {% if player_num == 2 %}you{% endif %}">
            <span>{{ p2.username }}{% if player_num == 2 %} (You){% endif %}</span>
            <span id="p2-score"></span>
        </div>
    </div>

    <div id="phase-display" class="phase-display"></div>

    <div id="table-area" class="game-area" style="display:none">
        <div id="table-top-section"></div>
        <div id="table-bottom-section"></div>
    </div>

    <div id="betting-area" class="game-area" style="display:none">
        <h3>Place Bets (Chips: <span id="chips-display"></span>)</h3>
        <input type="number" id="bet1" min="1" value="10">
        <button id="btn-place-bets" class="btn btn-primary">Deal</button>
    </div>

    <div id="action-area" class="action-area" style="display:none">
        <button class="btn btn-primary" id="btn-hit">Hit</button>
        <button class="btn btn-warning" id="btn-stand">Stand</button>
        <button class="btn btn-info" id="btn-double">Double</button>
        <button class="btn btn-secondary" id="btn-split">Split</button>
    </div>

    <div id="match-over-area" class="game-area" style="display:none">
        <h2 id="match-over-title"></h2>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
const MATCH_ID = {{ match.id }};
const PLAYER_NUM = {{ player_num }};

let state = null;
let polling = null;

function cardHtml(card){
    if(card.rank === "?") return '<div class="card card-back">?</div>';
    const suits = {hearts:'♥', diamonds:'♦', clubs:'♣', spades:'♠'};
    const color = (card.suit === 'hearts' || card.suit === 'diamonds') ? 'red' : 'black';
    return '<div class="card card-'+color+'">'+card.rank+
           '<span class="suit">'+suits[card.suit]+'</span></div>';
}

function hideAll(){
    document.querySelectorAll('.game-area').forEach(e=>e.style.display="none");
}

function buildDealerHtml(s){
    return `
        <div class="dealer-section">
            <h3>Dealer</h3>
            <div class="card-row">${s.round.dealer_cards.map(cardHtml).join('')}</div>
            <div>Value: ${s.round.dealer_value}</div>
        </div>
    `;
}

function buildPlayerHtml(s){
    const box = s.round.boxes[0];
    const hand = box.hands[0];
    return `
        <div class="boxes-section">
            <h3>Your Hand</h3>
            <div class="card-row">${hand.cards.map(cardHtml).join('')}</div>
            <div>Value: ${hand.value}</div>
        </div>
    `;
}

function renderState(s){
    state = s;
    hideAll();

    document.getElementById("phase-display").textContent = s.phase;

    if(s.match_over){
        document.getElementById("match-over-area").style.display="block";
        document.getElementById("match-over-title").textContent =
            s.match_result?.winner === PLAYER_NUM ? "You Won!" : "You Lost";
        stopPolling();
        return;
    }

    if(s.phase === "WAITING_BETS"){
        document.getElementById("betting-area").style.display="block";
        document.getElementById("chips-display").textContent = s.chips;
        return;
    }

    if(s.round){
        document.getElementById("table-area").style.display="block";
        document.getElementById("table-top-section").innerHTML = buildDealerHtml(s);
        document.getElementById("table-bottom-section").innerHTML = buildPlayerHtml(s);
    }

    if(s.phase === "PLAYER_TURN" && s.is_my_turn){
        document.getElementById("action-area").style.display="flex";
    }
}

async function apiCall(endpoint, body){
    const r = await fetch(`/game/${MATCH_ID}/${endpoint}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: body?JSON.stringify(body):null
    });
    const data = await r.json();
    renderState(data);
}

async function fetchState(){
    const r = await fetch(`/game/${MATCH_ID}/state`);
    const data = await r.json();
    renderState(data);
}

function startPolling(){
    if(polling) return;
    polling = setInterval(fetchState,800);
}

function stopPolling(){
    if(polling){ clearInterval(polling); polling=null; }
}

document.getElementById("btn-place-bets").onclick=()=>{
    const b=parseInt(document.getElementById("bet1").value);
    apiCall("bet",{bets:[b]});
};

["hit","stand","double","split"].forEach(a=>{
    document.getElementById("btn-"+a).onclick=()=>{
        apiCall("action",{action:a});
    };
});

fetchState();
startPolling();
</script>
{% endblock %}
