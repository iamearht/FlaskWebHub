{% extends "base.html" %}
{% block title %}Match #{{ match.id }} - Blackjack 1v1{% endblock %}
{% block content %}
<div class="game-container" id="game" data-match-id="{{ match.id }}" data-player-num="{{ player_num }}">
    <div class="game-header">
        <div class="player-info p1 {% if player_num == 1 %}you{% endif %}">
            <span class="player-name">{{ p1.username }}{% if player_num == 1 %} (You){% endif %}</span>
            <span class="player-score" id="p1-score"></span>
        </div>
        <div class="game-meta">
            <span class="stake-info">Stake: {{ match.stake }} coins</span>
            <span class="turn-info" id="turn-info"></span>
            <div class="timer-display" id="timer-display" style="display:none">
                <span class="timer-bar-container"><span class="timer-bar" id="timer-bar"></span></span>
                <span class="timer-text" id="timer-text"></span>
            </div>
        </div>
        <div class="player-info p2 {% if player_num == 2 %}you{% endif %}">
            <span class="player-name">{{ p2.username }}{% if player_num == 2 %} (You){% endif %}</span>
            <span class="player-score" id="p2-score"></span>
        </div>
    </div>

    <div class="game-board" id="game-board">
        <div id="phase-display" class="phase-display"></div>

        <div id="card-draw-area" class="game-area" style="display:none">
            <h2>Card Draw</h2>
            <p>Drawing cards to determine who chooses their role...</p>
            <div id="draw-cards-display" class="draw-cards-display"></div>
            <div id="draw-result-text" class="draw-result-text"></div>
        </div>

        <div id="choice-area" class="game-area" style="display:none">
            <h2 id="choice-title"></h2>
            <p>The match has 4 turns in a 1-2-2-1 pattern. If you go first as Player, you'll play: Player, Bank, Bank, Player.</p>
            <div id="choice-draw-cards" class="draw-cards-display"></div>
            <div class="choice-buttons">
                <button class="btn btn-primary" id="btn-go-player">Go First as Player</button>
                <button class="btn btn-secondary" id="btn-go-bank">Go First as Bank</button>
            </div>
        </div>

        <div id="betting-area" class="game-area" style="display:none">
            <h3>Place Your Bets <span id="chips-display" class="chips-badge"></span></h3>
            <div class="bet-boxes">
                <div class="bet-box">
                    <label>Box 1</label>
                    <input type="number" id="bet1" min="1" value="10" class="bet-input">
                </div>
                <div class="bet-box">
                    <label>Box 2 (optional)</label>
                    <input type="number" id="bet2" min="0" value="0" class="bet-input">
                </div>
                <div class="bet-box">
                    <label>Box 3 (optional)</label>
                    <input type="number" id="bet3" min="0" value="0" class="bet-input">
                </div>
            </div>
            <button class="btn btn-primary" id="btn-place-bets">Deal</button>
        </div>

        <div id="insurance-area" class="game-area" style="display:none">
            <h3>Dealer shows an Ace! Insurance?</h3>
            <p>Insurance costs half of each hand's bet. Pays 2:1 if dealer has Blackjack.</p>
            <div id="insurance-hands"></div>
            <button class="btn btn-primary" id="btn-insurance-submit">Confirm Insurance</button>
        </div>

        <div id="table-area" class="game-area" style="display:none">
            <div id="table-top-section"></div>
            <div id="table-bottom-section"></div>
        </div>

        <div id="action-area" class="action-area" style="display:none">
            <button class="btn btn-primary" id="btn-hit">Hit</button>
            <button class="btn btn-warning" id="btn-stand">Stand</button>
            <button class="btn btn-info" id="btn-double">Double</button>
            <button class="btn btn-secondary" id="btn-split">Split</button>
        </div>

        <div id="dealer-action-area" class="action-area" style="display:none">
            <span id="dealer-action-label" class="dealer-label"></span>
            <button class="btn btn-primary" id="btn-dealer-hit">Hit</button>
            <button class="btn btn-warning" id="btn-dealer-stand">Stand</button>
        </div>

        <div id="round-result-area" class="game-area" style="display:none">
            <h3>Round Complete</h3>
            <p id="round-result-chips"></p>
            <p id="round-result-auto" style="color:#aaa;font-size:0.85em"></p>
        </div>

        <div id="waiting-opponent" class="game-area" style="display:none">
            <h3 id="waiting-opponent-title">Opponent's Turn</h3>
            <p id="waiting-opponent-desc">Watching the other player...</p>
            <div class="spinner"></div>
        </div>

        <div id="match-over-area" class="game-area" style="display:none">
            <h2 id="match-over-title"></h2>
            <div id="match-over-details"></div>
            <a href="/match/{{ match.id }}" class="btn btn-primary">View Full Results</a>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const MATCH_ID = {{ match.id }};
const PLAYER_NUM = {{ player_num }};
let currentState = null;
let polling = null;
let actionLock = false;
let timerInterval = null;
let timerEnd = null;
let drawAnimationDone = false;
let roundResultAutoTimer = null;

function cardHtml(card) {
    if (card.rank === '?') return '<div class="card card-back">?</div>';
    const suitSymbols = {hearts: '\u2665', diamonds: '\u2666', clubs: '\u2663', spades: '\u2660'};
    const color = (card.suit === 'hearts' || card.suit === 'diamonds') ? 'red' : 'black';
    return '<div class="card card-' + color + '">' + card.rank + '<span class="suit">' + suitSymbols[card.suit] + '</span></div>';
}

function cardBackHtml() {
    return '<div class="card card-back">?</div>';
}

function startTimer(remaining) {
    if (timerInterval) clearInterval(timerInterval);
    const timerEl = document.getElementById('timer-display');
    const timerText = document.getElementById('timer-text');
    const timerBar = document.getElementById('timer-bar');

    if (remaining === null || remaining === undefined || remaining <= 0) {
        timerEl.style.display = 'none';
        return;
    }

    var totalTime = remaining;
    timerEl.style.display = 'block';
    timerEnd = Date.now() + remaining * 1000;

    timerInterval = setInterval(function() {
        var left = Math.max(0, (timerEnd - Date.now()) / 1000);
        timerText.textContent = Math.ceil(left) + 's';
        timerBar.style.width = (left / totalTime * 100) + '%';
        if (left <= 5) {
            timerBar.className = 'timer-bar timer-critical';
        } else {
            timerBar.className = 'timer-bar';
        }
        if (left <= 0) {
            clearInterval(timerInterval);
            actionLock = false;
            fetchState();
        }
    }, 100);
}

async function apiCall(endpoint, method, body) {
    if (actionLock) return null;
    actionLock = true;
    try {
        var opts = {method: method, headers: {'Content-Type': 'application/json'}};
        if (body) opts.body = JSON.stringify(body);
        var r = await fetch('/api/match/' + MATCH_ID + '/' + endpoint, opts);
        var data = await r.json();
        if (data.error) {
            console.warn('API error:', data.error);
            return null;
        }
        return data;
    } finally {
        actionLock = false;
    }
}

async function fetchState() {
    var data = await apiCall('state', 'GET');
    if (data) renderState(data);
}

function hideAll() {
    var els = document.querySelectorAll('.game-area, #action-area, #dealer-action-area');
    for (var i = 0; i < els.length; i++) els[i].style.display = 'none';
}

function getPlayerScoreText(s, playerKey) {
    var t1 = s.results[playerKey + '_turn1'];
    var t2 = s.results[playerKey + '_turn2'];
    if (t2 !== null && t2 !== undefined) return 'Final: ' + t2;
    if (t1 !== null && t1 !== undefined) return 'R1: ' + t1;
    return '-';
}

function renderState(s) {
    currentState = s;
    hideAll();
    var allBtns = document.querySelectorAll('.game-area button, #action-area button, #dealer-action-area button');
    for (var i = 0; i < allBtns.length; i++) allBtns[i].disabled = false;

    document.getElementById('p1-score').textContent = getPlayerScoreText(s, 'player1');
    document.getElementById('p2-score').textContent = getPlayerScoreText(s, 'player2');

    var turnText = '';
    if (s.phase === 'CARD_DRAW' || s.phase === 'CHOICE') {
        turnText = 'Setup';
    } else {
        turnText = 'Turn ' + Math.min(s.current_turn + 1, 4) + '/4';
    }
    document.getElementById('turn-info').textContent = turnText;

    var phaseEl = document.getElementById('phase-display');

    if (s.match_over || s.phase === 'MATCH_OVER') {
        phaseEl.textContent = 'Match Over';
        showMatchOver(s);
        stopPolling();
        document.getElementById('timer-display').style.display = 'none';
        return;
    }

    if (s.phase === 'CARD_DRAW' || (s.phase === 'CHOICE' && !drawAnimationDone)) {
        phaseEl.textContent = 'Card Draw';
        showCardDrawAnimation(s);
        return;
    }

    if (s.phase === 'CHOICE') {
        phaseEl.textContent = 'Choose Role';
        showChoice(s);
        if (s.is_my_turn) {
            stopPolling();
            if (s.timer_remaining !== null && s.timer_remaining !== undefined) {
                startTimer(s.timer_remaining);
            }
        } else {
            document.getElementById('timer-display').style.display = 'none';
            startPolling();
        }
        return;
    }

    if (!s.is_my_turn) {
        if (s.round && s.phase !== 'WAITING_BETS') {
            phaseEl.textContent = s.i_am_dealer ? "Watching Player" : "Watching Opponent";
            showTable(s);
            document.getElementById('waiting-opponent').style.display = 'block';
            document.getElementById('waiting-opponent-title').textContent = s.i_am_dealer ? "Player's Turn" : "Opponent's Turn";
            document.getElementById('waiting-opponent-desc').textContent = 'Watching live...';
        } else {
            phaseEl.textContent = "Opponent's Turn";
            document.getElementById('waiting-opponent').style.display = 'block';
            document.getElementById('waiting-opponent-title').textContent = "Opponent's Turn";
            document.getElementById('waiting-opponent-desc').textContent = 'Waiting for the other player...';
        }
        document.getElementById('timer-display').style.display = 'none';
        startPolling();
        return;
    }

    stopPolling();

    if (s.timer_remaining !== null && s.timer_remaining !== undefined) {
        startTimer(s.timer_remaining);
    }

    if (s.phase === 'WAITING_BETS') {
        phaseEl.textContent = 'Place Bets';
        showBetting(s);
    } else if (s.phase === 'INSURANCE') {
        phaseEl.textContent = 'Insurance';
        showTable(s);
        showInsurance(s);
    } else if (s.phase === 'PLAYER_TURN') {
        phaseEl.textContent = 'Your Turn';
        showTable(s);
        showActions(s);
    } else if (s.phase === 'DEALER_TURN') {
        phaseEl.textContent = 'Dealer Decision';
        showTable(s);
        showDealerActions(s);
    } else if (s.phase === 'ROUND_RESULT') {
        phaseEl.textContent = 'Round Result';
        showTable(s);
        showRoundResult(s);
    }
}

function showCardDrawAnimation(s) {
    var area = document.getElementById('card-draw-area');
    area.style.display = 'block';
    document.getElementById('timer-display').style.display = 'none';

    var p1Cards = s.draw_cards.player1;
    var p2Cards = s.draw_cards.player2;

    var elapsed = (Date.now() / 1000) - (s.draw_timestamp || 0);
    var revealDelay = 3;

    if (elapsed < revealDelay) {
        var html = '<div class="draw-hands">';
        html += '<div class="draw-player"><h4>Player 1</h4><div class="card-row">';
        for (var i = 0; i < p1Cards.length; i++) html += cardBackHtml();
        html += '</div></div>';
        html += '<div class="draw-vs">VS</div>';
        html += '<div class="draw-player"><h4>Player 2</h4><div class="card-row">';
        for (var i = 0; i < p2Cards.length; i++) html += cardBackHtml();
        html += '</div></div>';
        html += '</div>';
        document.getElementById('draw-cards-display').innerHTML = html;
        document.getElementById('draw-result-text').textContent = 'Revealing cards...';

        var timeLeft = (revealDelay - elapsed) * 1000;
        setTimeout(function() {
            drawAnimationDone = true;
            renderState(currentState);
        }, timeLeft);
        return;
    }

    drawAnimationDone = true;

    var html = '<div class="draw-hands">';
    html += '<div class="draw-player"><h4>Player 1</h4><div class="card-row">';
    for (var i = 0; i < p1Cards.length; i++) html += cardHtml(p1Cards[i]);
    html += '</div></div>';
    html += '<div class="draw-vs">VS</div>';
    html += '<div class="draw-player"><h4>Player 2</h4><div class="card-row">';
    for (var i = 0; i < p2Cards.length; i++) html += cardHtml(p2Cards[i]);
    html += '</div></div>';
    html += '</div>';
    document.getElementById('draw-cards-display').innerHTML = html;

    var winnerText = '';
    if (s.draw_winner === PLAYER_NUM) {
        winnerText = 'You drew the higher card!';
    } else {
        winnerText = 'Opponent drew the higher card!';
    }

    var tieDraws = p1Cards.length - 1;
    if (tieDraws > 0) {
        winnerText = tieDraws + ' tie(s) before deciding. ' + winnerText;
    }
    document.getElementById('draw-result-text').textContent = winnerText;

    if (s.phase === 'CHOICE') {
        setTimeout(function() {
            renderState(currentState);
        }, 2000);
    }
}

function showChoice(s) {
    var area = document.getElementById('choice-area');
    area.style.display = 'block';

    var html = '<div class="draw-hands">';
    var p1Cards = s.draw_cards.player1;
    var p2Cards = s.draw_cards.player2;

    html += '<div class="draw-player"><h4>Player 1</h4><div class="card-row">';
    for (var i = 0; i < p1Cards.length; i++) html += cardHtml(p1Cards[i]);
    html += '</div></div>';

    html += '<div class="draw-vs">VS</div>';

    html += '<div class="draw-player"><h4>Player 2</h4><div class="card-row">';
    for (var i = 0; i < p2Cards.length; i++) html += cardHtml(p2Cards[i]);
    html += '</div></div>';
    html += '</div>';

    document.getElementById('choice-draw-cards').innerHTML = html;

    var title = document.getElementById('choice-title');
    if (s.chooser === PLAYER_NUM) {
        title.textContent = 'You won the draw! Choose your starting role:';
        document.getElementById('btn-go-player').style.display = '';
        document.getElementById('btn-go-bank').style.display = '';
    } else {
        title.textContent = 'Opponent won the draw. Waiting for their choice...';
        document.getElementById('btn-go-player').style.display = 'none';
        document.getElementById('btn-go-bank').style.display = 'none';
    }
}

function showBetting(s) {
    document.getElementById('betting-area').style.display = 'block';
    document.getElementById('chips-display').textContent = 'Chips: ' + s.chips;
    document.getElementById('bet1').max = s.chips;
}

function showInsurance(s) {
    document.getElementById('insurance-area').style.display = 'block';
    var handsDiv = document.getElementById('insurance-hands');
    var html = '';
    var handIdx = 0;
    for (var bi = 0; bi < s.round.boxes.length; bi++) {
        var box = s.round.boxes[bi];
        for (var hi = 0; hi < box.hands.length; hi++) {
            var hand = box.hands[hi];
            var insCost = Math.floor(hand.bet / 2);
            if (insCost < 1) insCost = 1;
            var label = 'Box ' + (bi + 1);
            if (box.hands.length > 1) label += ' Hand ' + (hi + 1);
            html += '<div class="insurance-hand-option">';
            html += '<label><input type="checkbox" class="insurance-check" data-idx="' + handIdx + '"> ';
            html += label + ' (Bet: ' + hand.bet + ') — Insurance cost: ' + insCost + ' chips';
            html += '</label>';
            html += '<div class="card-row" style="margin-top:4px">' + hand.cards.map(cardHtml).join('') + '</div>';
            html += '</div>';
            handIdx++;
        }
    }
    handsDiv.innerHTML = html;
}

function buildDealerHtml(s) {
    var dealerLabel = s.i_am_dealer ? 'Your Cards (Dealer)' : 'Dealer';
    var valueText = s.round.resolved || s.i_am_dealer ? 'Value: ' + s.round.dealer_value : '';
    return '<div class="dealer-section"><h3>' + dealerLabel + '</h3>' +
        '<div class="card-row">' + s.round.dealer_cards.map(cardHtml).join('') + '</div>' +
        '<span class="hand-value">' + valueText + '</span></div>';
}

function buildBoxesHtml(s) {
    var boxesLabel = s.i_am_dealer ? "Opponent's Hands" : 'Your Hands';
    var html = '<div class="boxes-section"><h3 class="boxes-label">' + boxesLabel + '</h3>';
    for (var bi = 0; bi < s.round.boxes.length; bi++) {
        var box = s.round.boxes[bi];
        html += '<div class="box-container">';
        for (var hi = 0; hi < box.hands.length; hi++) {
            var hand = box.hands[hi];
            var isActive = s.phase === 'PLAYER_TURN' && bi === s.round.current_box && hi === s.round.current_hand && hand.status === 'active';
            var cls = 'hand-container' + (isActive ? ' active-hand' : '') + (hand.result ? ' result-' + hand.result : '');

            var label = 'Box ' + (bi + 1);
            if (box.hands.length > 1) label += ' Hand ' + (hi + 1);
            var statusText = '';
            if (hand.result) {
                var labels = {win: 'WIN', lose: 'LOSE', push: 'PUSH', blackjack_win: 'BLACKJACK!'};
                statusText = '<span class="hand-result result-' + hand.result + '">' + (labels[hand.result] || hand.result) + '</span>';
            }

            html += '<div class="' + cls + '">' +
                '<div class="hand-header">' + label + ' (Bet: ' + hand.bet + ')' +
                (hand.is_doubled ? ' [DOUBLED]' : '') + (hand.is_split ? ' [SPLIT]' : '') + '</div>' +
                '<div class="card-row">' + hand.cards.map(cardHtml).join('') + '</div>' +
                '<div class="hand-value">Value: ' + hand.value + ' ' + statusText + '</div></div>';
        }
        html += '</div>';
    }
    html += '</div>';
    return html;
}

function showTable(s) {
    document.getElementById('table-area').style.display = 'block';
    var topSection = document.getElementById('table-top-section');
    var bottomSection = document.getElementById('table-bottom-section');

    if (s.i_am_dealer) {
        topSection.innerHTML = buildBoxesHtml(s);
        bottomSection.innerHTML = buildDealerHtml(s);
    } else {
        topSection.innerHTML = buildDealerHtml(s);
        bottomSection.innerHTML = buildBoxesHtml(s);
    }
}

function showActions(s) {
    var rnd = s.round;
    if (rnd.current_box >= rnd.boxes.length) return;
    var box = rnd.boxes[rnd.current_box];
    if (rnd.current_hand >= box.hands.length) return;
    var hand = box.hands[rnd.current_hand];
    if (hand.status !== 'active') return;

    document.getElementById('action-area').style.display = 'flex';
    document.getElementById('btn-double').style.display = hand.can_double ? '' : 'none';
    document.getElementById('btn-split').style.display = hand.can_split ? '' : 'none';
}

function showDealerActions(s) {
    document.getElementById('dealer-action-area').style.display = 'flex';
    document.getElementById('dealer-action-label').innerHTML = 'Your hand is at <strong>' + s.round.dealer_value + '</strong> — Hit or Stand?';
}

function showRoundResult(s) {
    document.getElementById('round-result-area').style.display = 'block';
    var msg = 'Chips remaining: ' + s.chips;
    if (s.cut_card_reached) msg += ' | Cut card reached - turn will end';
    if (s.chips <= 0) msg += ' | No chips left - turn will end';
    document.getElementById('round-result-chips').textContent = msg;
    document.getElementById('round-result-auto').textContent = 'Continuing automatically...';

    if (roundResultAutoTimer) clearTimeout(roundResultAutoTimer);
    roundResultAutoTimer = setTimeout(async function() {
        var data = await apiCall('next_round', 'POST');
        if (data) renderState(data);
    }, 3000);
}

function showMatchOver(s) {
    document.getElementById('match-over-area').style.display = 'block';
    var r = s.match_result;
    var title = document.getElementById('match-over-title');
    var details = document.getElementById('match-over-details');

    if (r.forfeit) {
        if (r.winner === PLAYER_NUM) {
            title.textContent = 'Opponent Forfeited - You Win!';
            title.className = 'win-text';
        } else {
            title.textContent = 'You Forfeited';
            title.className = 'lose-text';
        }
        details.innerHTML = '<p>Match ended by forfeit.</p>';
        return;
    }

    if (r.winner === 0) {
        title.textContent = "It's a Tie!";
    } else if (r.winner === PLAYER_NUM) {
        title.textContent = 'You Won!';
        title.className = 'win-text';
    } else {
        title.textContent = 'You Lost';
        title.className = 'lose-text';
    }
    details.innerHTML = '<p>Player 1 Final Chips: ' + r.player1_total + '</p><p>Player 2 Final Chips: ' + r.player2_total + '</p>';
}

function startPolling() {
    if (polling) return;
    polling = setInterval(fetchState, 1500);
}

function stopPolling() {
    if (polling) { clearInterval(polling); polling = null; }
}

document.getElementById('btn-go-player').addEventListener('click', async function() {
    var data = await apiCall('choice', 'POST', {go_first_as_player: true});
    if (data) renderState(data);
});

document.getElementById('btn-go-bank').addEventListener('click', async function() {
    var data = await apiCall('choice', 'POST', {go_first_as_player: false});
    if (data) renderState(data);
});

document.getElementById('btn-place-bets').addEventListener('click', async function() {
    var bets = [];
    var b1 = parseInt(document.getElementById('bet1').value) || 0;
    var b2 = parseInt(document.getElementById('bet2').value) || 0;
    var b3 = parseInt(document.getElementById('bet3').value) || 0;
    if (b1 > 0) bets.push(b1);
    if (b2 > 0) bets.push(b2);
    if (b3 > 0) bets.push(b3);
    if (bets.length === 0) { alert('Place at least one bet'); return; }
    var data = await apiCall('bet', 'POST', {bets: bets});
    if (data) renderState(data);
});

document.getElementById('btn-insurance-submit').addEventListener('click', async function() {
    var checks = document.querySelectorAll('.insurance-check');
    var decisions = [];
    for (var i = 0; i < checks.length; i++) {
        decisions.push(checks[i].checked);
    }
    var data = await apiCall('insurance', 'POST', {decisions: decisions});
    if (data) renderState(data);
});

['hit', 'stand', 'double', 'split'].forEach(function(action) {
    document.getElementById('btn-' + action).addEventListener('click', async function() {
        var data = await apiCall('action', 'POST', {action: action});
        if (data) renderState(data);
    });
});

document.getElementById('btn-dealer-hit').addEventListener('click', async function() {
    var data = await apiCall('dealer_action', 'POST', {action: 'hit'});
    if (data) renderState(data);
});

document.getElementById('btn-dealer-stand').addEventListener('click', async function() {
    var data = await apiCall('dealer_action', 'POST', {action: 'stand'});
    if (data) renderState(data);
});

fetchState();
startPolling();
</script>
{% endblock %}
