{% extends "base.html" %}
{% block title %}Match #{{ match.id }} - Blackjack 1v1{% endblock %}
{% block content %}
<div class="game-container" id="game" data-match-id="{{ match.id }}" data-player-num="{{ player_num }}">
    <div class="game-header">
        <div class="player-info p1 {% if player_num == 1 %}you{% endif %}">
            <span class="player-name">{{ p1.username }}{% if player_num == 1 %} (You){% endif %}</span>
            <span class="player-score" id="p1-score"></span>
        </div>
        <div class="game-meta">
            <span class="stake-info">Stake: {{ match.stake }} coins</span>
            <span class="turn-info" id="turn-info"></span>
            <div class="timer-display" id="timer-display" style="display:none">
                <span class="timer-bar-container"><span class="timer-bar" id="timer-bar"></span></span>
                <span class="timer-text" id="timer-text"></span>
            </div>
        </div>
        <div class="player-info p2 {% if player_num == 2 %}you{% endif %}">
            <span class="player-name">{{ p2.username }}{% if player_num == 2 %} (You){% endif %}</span>
            <span class="player-score" id="p2-score"></span>
        </div>
    </div>

    <div class="game-board" id="game-board">
        <div id="phase-display" class="phase-display"></div>

        <div id="turn-start-area" class="game-area" style="display:none">
            <h2 id="turn-start-title"></h2>
            <p id="turn-start-desc"></p>
            <button class="btn btn-primary" id="btn-start-turn">Start Turn</button>
        </div>

        <div id="betting-area" class="game-area" style="display:none">
            <h3>Place Your Bets <span id="chips-display" class="chips-badge"></span></h3>
            <div class="bet-boxes">
                <div class="bet-box">
                    <label>Box 1</label>
                    <input type="number" id="bet1" min="1" value="10" class="bet-input">
                </div>
                <div class="bet-box">
                    <label>Box 2 (optional)</label>
                    <input type="number" id="bet2" min="0" value="0" class="bet-input">
                </div>
                <div class="bet-box">
                    <label>Box 3 (optional)</label>
                    <input type="number" id="bet3" min="0" value="0" class="bet-input">
                </div>
            </div>
            <button class="btn btn-primary" id="btn-place-bets">Deal</button>
        </div>

        <div id="insurance-area" class="game-area" style="display:none">
            <h3>Dealer shows an Ace! Insurance?</h3>
            <p id="insurance-cost"></p>
            <button class="btn btn-success" id="btn-insurance-yes">Take Insurance</button>
            <button class="btn btn-danger" id="btn-insurance-no">No Insurance</button>
        </div>

        <div id="table-area" class="game-area" style="display:none">
            <div class="dealer-section">
                <h3>Dealer</h3>
                <div id="dealer-cards" class="card-row"></div>
                <span id="dealer-value" class="hand-value"></span>
            </div>
            <div id="boxes-section" class="boxes-section"></div>
        </div>

        <div id="action-area" class="action-area" style="display:none">
            <button class="btn btn-primary" id="btn-hit">Hit</button>
            <button class="btn btn-warning" id="btn-stand">Stand</button>
            <button class="btn btn-info" id="btn-double">Double</button>
            <button class="btn btn-secondary" id="btn-split">Split</button>
        </div>

        <div id="dealer-action-area" class="action-area" style="display:none">
            <span id="dealer-action-label" class="dealer-label">Dealer has <strong id="dealer-action-value"></strong> â€” Hit or Stand?</span>
            <button class="btn btn-primary" id="btn-dealer-hit">Hit</button>
            <button class="btn btn-warning" id="btn-dealer-stand">Stand</button>
        </div>

        <div id="round-result-area" class="game-area" style="display:none">
            <h3>Round Complete</h3>
            <p id="round-result-chips"></p>
            <button class="btn btn-primary" id="btn-next-round">Continue</button>
        </div>

        <div id="waiting-opponent" class="game-area" style="display:none">
            <h3 id="waiting-opponent-title">Opponent's Turn</h3>
            <p id="waiting-opponent-desc">Watching the other player...</p>
            <div class="spinner"></div>
        </div>

        <div id="match-over-area" class="game-area" style="display:none">
            <h2 id="match-over-title"></h2>
            <div id="match-over-details"></div>
            <a href="/match/{{ match.id }}" class="btn btn-primary">View Full Results</a>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const MATCH_ID = {{ match.id }};
const PLAYER_NUM = {{ player_num }};
let currentState = null;
let polling = null;
let actionLock = false;
let timerInterval = null;
let timerEnd = null;

function cardHtml(card) {
    if (card.rank === '?') return '<div class="card card-back">?</div>';
    const suitSymbols = {hearts: '\u2665', diamonds: '\u2666', clubs: '\u2663', spades: '\u2660'};
    const color = (card.suit === 'hearts' || card.suit === 'diamonds') ? 'red' : 'black';
    return '<div class="card card-' + color + '">' + card.rank + '<span class="suit">' + suitSymbols[card.suit] + '</span></div>';
}

function startTimer(remaining) {
    if (timerInterval) clearInterval(timerInterval);
    const timerEl = document.getElementById('timer-display');
    const timerText = document.getElementById('timer-text');
    const timerBar = document.getElementById('timer-bar');

    if (remaining === null || remaining === undefined || remaining <= 0) {
        timerEl.style.display = 'none';
        return;
    }

    var totalTime = remaining;
    timerEl.style.display = 'block';
    timerEnd = Date.now() + remaining * 1000;

    timerInterval = setInterval(function() {
        var left = Math.max(0, (timerEnd - Date.now()) / 1000);
        timerText.textContent = Math.ceil(left) + 's';
        timerBar.style.width = (left / totalTime * 100) + '%';
        if (left <= 5) {
            timerBar.className = 'timer-bar timer-critical';
        } else {
            timerBar.className = 'timer-bar';
        }
        if (left <= 0) {
            clearInterval(timerInterval);
            actionLock = false;
            fetchState();
        }
    }, 100);
}

async function apiCall(endpoint, method, body) {
    if (actionLock) return null;
    actionLock = true;
    try {
        var opts = {method: method, headers: {'Content-Type': 'application/json'}};
        if (body) opts.body = JSON.stringify(body);
        var r = await fetch('/api/match/' + MATCH_ID + '/' + endpoint, opts);
        var data = await r.json();
        if (data.error) {
            alert(data.error);
            return null;
        }
        return data;
    } finally {
        actionLock = false;
    }
}

async function fetchState() {
    var data = await apiCall('state', 'GET');
    if (data) renderState(data);
}

function hideAll() {
    var els = document.querySelectorAll('.game-area, #action-area, #dealer-action-area');
    for (var i = 0; i < els.length; i++) els[i].style.display = 'none';
}

function renderState(s) {
    currentState = s;
    hideAll();
    var allBtns = document.querySelectorAll('.game-area button, #action-area button');
    for (var i = 0; i < allBtns.length; i++) allBtns[i].disabled = false;

    var p1Score = s.results.player1 !== null ? s.results.player1 : '-';
    var p2Score = s.results.player2 !== null ? s.results.player2 : '-';
    document.getElementById('p1-score').textContent = 'Score: ' + p1Score;
    document.getElementById('p2-score').textContent = 'Score: ' + p2Score;
    document.getElementById('turn-info').textContent = 'Turn ' + Math.min(s.current_turn + 1, 2) + '/2';

    var phaseEl = document.getElementById('phase-display');

    if (s.match_over || s.phase === 'MATCH_OVER') {
        phaseEl.textContent = 'Match Over';
        showMatchOver(s);
        stopPolling();
        document.getElementById('timer-display').style.display = 'none';
        return;
    }

    if (s.phase === 'TURN_START') {
        phaseEl.textContent = 'Turn Start';
        showTurnStart(s);
        document.getElementById('timer-display').style.display = 'none';
        return;
    }

    if (!s.is_my_turn) {
        if (s.round && s.phase !== 'WAITING_BETS' && s.phase !== 'TURN_START') {
            phaseEl.textContent = "Watching Opponent";
            showTable(s);
            document.getElementById('waiting-opponent').style.display = 'block';
            document.getElementById('waiting-opponent-title').textContent = "Opponent's Turn";
            document.getElementById('waiting-opponent-desc').textContent = 'Watching live...';
        } else {
            phaseEl.textContent = "Opponent's Turn";
            document.getElementById('waiting-opponent').style.display = 'block';
            document.getElementById('waiting-opponent-title').textContent = "Opponent's Turn";
            document.getElementById('waiting-opponent-desc').textContent = 'Waiting for the other player...';
        }
        document.getElementById('timer-display').style.display = 'none';
        startPolling();
        return;
    }

    stopPolling();

    if (s.timer_remaining !== null && s.timer_remaining !== undefined) {
        startTimer(s.timer_remaining);
    }

    if (s.phase === 'WAITING_BETS') {
        phaseEl.textContent = 'Place Bets';
        showBetting(s);
    } else if (s.phase === 'INSURANCE') {
        phaseEl.textContent = 'Insurance';
        showTable(s);
        showInsurance(s);
    } else if (s.phase === 'PLAYER_TURN') {
        phaseEl.textContent = 'Your Turn';
        showTable(s);
        showActions(s);
    } else if (s.phase === 'DEALER_TURN') {
        phaseEl.textContent = 'Dealer Decision';
        showTable(s);
        showDealerActions(s);
    } else if (s.phase === 'ROUND_RESULT') {
        phaseEl.textContent = 'Round Result';
        showTable(s);
        showRoundResult(s);
    }
}

function showTurnStart(s) {
    var area = document.getElementById('turn-start-area');
    area.style.display = 'block';
    var title = document.getElementById('turn-start-title');
    var desc = document.getElementById('turn-start-desc');
    if (s.current_player_role === PLAYER_NUM) {
        title.textContent = 'Turn ' + (s.current_turn + 1) + ': You are the Player';
        desc.textContent = 'You will play blackjack hands. Try to keep as many of your 100 chips as possible!';
    } else {
        title.textContent = 'Turn ' + (s.current_turn + 1) + ': You are the Dealer';
        desc.textContent = 'Your opponent plays this turn. The dealer is automated.';
    }
}

function showBetting(s) {
    document.getElementById('betting-area').style.display = 'block';
    document.getElementById('chips-display').textContent = 'Chips: ' + s.chips;
    document.getElementById('bet1').max = s.chips;
}

function showInsurance(s) {
    document.getElementById('insurance-area').style.display = 'block';
    var totalBet = 0;
    for (var i = 0; i < s.round.boxes.length; i++) {
        totalBet += s.round.boxes[i].hands[0].bet;
    }
    document.getElementById('insurance-cost').textContent = 'Insurance costs ' + Math.floor(totalBet / 2) + ' chips';
}

function showTable(s) {
    document.getElementById('table-area').style.display = 'block';
    var dealerCards = document.getElementById('dealer-cards');
    dealerCards.innerHTML = s.round.dealer_cards.map(cardHtml).join('');
    document.getElementById('dealer-value').textContent = s.round.resolved ? 'Value: ' + s.round.dealer_value : '';

    var boxesSection = document.getElementById('boxes-section');
    boxesSection.innerHTML = '';

    for (var bi = 0; bi < s.round.boxes.length; bi++) {
        var box = s.round.boxes[bi];
        var boxDiv = document.createElement('div');
        boxDiv.className = 'box-container';

        for (var hi = 0; hi < box.hands.length; hi++) {
            var hand = box.hands[hi];
            var isActive = s.phase === 'PLAYER_TURN' && bi === s.round.current_box && hi === s.round.current_hand && hand.status === 'active';
            var handDiv = document.createElement('div');
            handDiv.className = 'hand-container' + (isActive ? ' active-hand' : '') + (hand.result ? ' result-' + hand.result : '');

            var label = 'Box ' + (bi + 1);
            if (box.hands.length > 1) label += ' Hand ' + (hi + 1);
            var statusText = '';
            if (hand.result) {
                var labels = {win: 'WIN', lose: 'LOSE', push: 'PUSH', blackjack_win: 'BLACKJACK!'};
                statusText = '<span class="hand-result result-' + hand.result + '">' + (labels[hand.result] || hand.result) + '</span>';
            }

            handDiv.innerHTML =
                '<div class="hand-header">' + label + ' (Bet: ' + hand.bet + ')' +
                (hand.is_doubled ? ' [DOUBLED]' : '') + (hand.is_split ? ' [SPLIT]' : '') + '</div>' +
                '<div class="card-row">' + hand.cards.map(cardHtml).join('') + '</div>' +
                '<div class="hand-value">Value: ' + hand.value + ' ' + statusText + '</div>';
            boxDiv.appendChild(handDiv);
        }
        boxesSection.appendChild(boxDiv);
    }
}

function showActions(s) {
    var rnd = s.round;
    if (rnd.current_box >= rnd.boxes.length) return;
    var box = rnd.boxes[rnd.current_box];
    if (rnd.current_hand >= box.hands.length) return;
    var hand = box.hands[rnd.current_hand];
    if (hand.status !== 'active') return;

    document.getElementById('action-area').style.display = 'flex';
    document.getElementById('btn-double').style.display = hand.can_double ? '' : 'none';
    document.getElementById('btn-split').style.display = hand.can_split ? '' : 'none';
}

function showDealerActions(s) {
    document.getElementById('dealer-action-area').style.display = 'flex';
    document.getElementById('dealer-action-value').textContent = s.round.dealer_value;
}

function showRoundResult(s) {
    document.getElementById('round-result-area').style.display = 'block';
    var msg = 'Chips remaining: ' + s.chips;
    if (s.cut_card_reached) msg += ' | Cut card reached - turn will end';
    if (s.chips <= 0) msg += ' | No chips left - turn will end';
    document.getElementById('round-result-chips').textContent = msg;
}

function showMatchOver(s) {
    document.getElementById('match-over-area').style.display = 'block';
    var r = s.match_result;
    var title = document.getElementById('match-over-title');
    var details = document.getElementById('match-over-details');

    if (r.winner === 0) {
        title.textContent = "It's a Tie!";
    } else if (r.winner === PLAYER_NUM) {
        title.textContent = 'You Won!';
        title.className = 'win-text';
    } else {
        title.textContent = 'You Lost';
        title.className = 'lose-text';
    }
    details.innerHTML = '<p>Player 1 Total: ' + r.player1_total + '</p><p>Player 2 Total: ' + r.player2_total + '</p>';
}

function startPolling() {
    if (polling) return;
    polling = setInterval(fetchState, 3000);
}

function stopPolling() {
    if (polling) { clearInterval(polling); polling = null; }
}

document.getElementById('btn-start-turn').addEventListener('click', async function() {
    var data = await apiCall('start_turn', 'POST');
    if (data) renderState(data);
});

document.getElementById('btn-place-bets').addEventListener('click', async function() {
    var bets = [];
    var b1 = parseInt(document.getElementById('bet1').value) || 0;
    var b2 = parseInt(document.getElementById('bet2').value) || 0;
    var b3 = parseInt(document.getElementById('bet3').value) || 0;
    if (b1 > 0) bets.push(b1);
    if (b2 > 0) bets.push(b2);
    if (b3 > 0) bets.push(b3);
    if (bets.length === 0) { alert('Place at least one bet'); return; }
    var data = await apiCall('bet', 'POST', {bets: bets});
    if (data) renderState(data);
});

document.getElementById('btn-insurance-yes').addEventListener('click', async function() {
    var data = await apiCall('insurance', 'POST', {take: true});
    if (data) renderState(data);
});

document.getElementById('btn-insurance-no').addEventListener('click', async function() {
    var data = await apiCall('insurance', 'POST', {take: false});
    if (data) renderState(data);
});

['hit', 'stand', 'double', 'split'].forEach(function(action) {
    document.getElementById('btn-' + action).addEventListener('click', async function() {
        var data = await apiCall('action', 'POST', {action: action});
        if (data) renderState(data);
    });
});

document.getElementById('btn-dealer-hit').addEventListener('click', async function() {
    var data = await apiCall('dealer_action', 'POST', {action: 'hit'});
    if (data) renderState(data);
});

document.getElementById('btn-dealer-stand').addEventListener('click', async function() {
    var data = await apiCall('dealer_action', 'POST', {action: 'stand'});
    if (data) renderState(data);
});

document.getElementById('btn-next-round').addEventListener('click', async function() {
    var data = await apiCall('next_round', 'POST');
    if (data) renderState(data);
});

fetchState();
</script>
{% endblock %}
