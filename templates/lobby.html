{% extends "base.html" %}
{% block title %}Lobby - Blackjack Platform{% endblock %}
{% block content %}

<div class="lobby">

  <!-- HEADER -->
  <div class="lobby-header">
    <h1>Game Lobby</h1>
    <div class="user-info">
      <span class="coins-display">
        Your Coins:
        <strong id="coins-display">{{ user.coins }}</strong>
      </span>
    </div>
  </div>


  <!-- JACKPOT SECTION -->
  {% if jackpot_pools %}
  <div class="lobby-section jackpot-banner-section">
    <div class="jackpot-banner">
      <a href="/jackpots" style="text-decoration:none; color:inherit;">
        <h3>Jackpot Pools</h3>

        <div style="display:flex; gap:20px; flex-wrap:wrap;">
          <div>
            <strong>Standard:</strong>
            {{ jackpot_pools.standard.pool_amount if jackpot_pools.standard else 0 }} coins
          </div>

          <div>
            <strong>Joker:</strong>
            {{ jackpot_pools.joker.pool_amount if jackpot_pools.joker else 0 }} coins
          </div>
        </div>
      </a>
    </div>
  </div>
  {% endif %}


  <!-- âœ… YOUR ACTIVE GAMES -->
  {% if my_active %}
  <div class="lobby-section">
    <h2>Your Active Games</h2>

    <div class="match-list">

      {% for m in my_active %}
        {% set opponent = m.player2 if m.player1_id == user.id else m.player1 %}

        <div class="match-card">

          <div class="match-info">
            <span class="match-stake">
              Match #{{ m.id }}
            </span>

            <span>
              vs {{ opponent.username if opponent else "Unknown" }}
            </span>

            <span class="mode-badge">
              {{ game_modes[m.game_mode].name
                 if m.game_mode in game_modes
                 else m.game_mode }}
            </span>
          </div>

          <div class="match-actions">

            <!-- PLAY -->
            <a href="{{ url_for('game.play', match_id=m.id) }}"
               class="btn btn-primary">
              Play
            </a>

            <!-- FORFEIT -->
            <form method="POST"
                  action="{{ url_for('game.forfeit_match', match_id=m.id) }}"
                  onsubmit="return confirm('Are you sure you want to forfeit this match?');">
              <button type="submit"
                      class="btn btn-danger">
                Forfeit
              </button>
            </form>

          </div>
        </div>

      {% endfor %}

    </div>
  </div>
  {% endif %}


  <!-- CREATE MATCH -->
  <div class="lobby-section">
    <h2>Create a Match</h2>

    <form method="POST"
          action="{{ url_for('game.create_match') }}"
          class="create-match-form">

      <div class="form-group">
        <label>Game Mode</label>
        <select name="game_mode">
          {% for mode_key, mode_info in game_modes.items() %}
            <option value="{{ mode_key }}">
              {{ mode_info.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>Stake Amount (min 10 coins)</label>
        <input type="number"
               name="stake"
               min="10"
               max="{{ user.coins }}"
               value="50"
               required>
      </div>

      <button type="submit" class="btn btn-primary">
        Create Match
      </button>
    </form>
  </div>


  <!-- AVAILABLE MATCHES (WAITING ONLY) -->
  <div class="lobby-section">
    <h2>Available Matches</h2>

    <div id="lobby-container" class="match-list">

      {% for m in waiting %}

        {% set is_creator = (m.player1_id == user.id) %}
        {% set has_opponent = (m.player2_id is not none) %}

        <div class="match-card">

          <div class="match-info">
            <span class="match-stake">
              Stake: {{ m.stake }} coins
            </span>

            <span>
              {{ m.player1.username }}
              {% if m.player2 %}
                vs {{ m.player2.username }}
              {% else %}
                (waiting)
              {% endif %}
            </span>

            <span class="mode-badge">
              {{ game_modes[m.game_mode].name
                 if m.game_mode in game_modes
                 else m.game_mode }}
            </span>
          </div>


          <div class="match-actions">

            {% if is_creator and not has_opponent %}

              <!-- Creator can cancel waiting lobby -->
              <form method="POST"
                    action="{{ url_for('game.cancel_match', match_id=m.id) }}">
                <button type="submit"
                        class="btn btn-danger">
                  Cancel Lobby
                </button>
              </form>

            {% elif not has_opponent %}

              <!-- Other player can join -->
              <form method="POST"
                    action="{{ url_for('game.join_match', match_id=m.id) }}">
                <button type="submit"
                        class="btn btn-success"
                        {% if m.stake > user.coins %}disabled{% endif %}>
                  Join
                </button>
              </form>

            {% else %}

              <button type="button"
                      class="btn btn-secondary"
                      disabled>
                Waiting...
              </button>

            {% endif %}

          </div>
        </div>

      {% endfor %}
    </div>

    {% if not waiting %}
      <p class="empty-text">
        No matches available.
      </p>
    {% endif %}
  </div>

</div>

{% endblock %}